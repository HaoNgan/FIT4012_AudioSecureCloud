<!-- Modern logs.html -->
{% extends 'base.html' %}
{% block title %}Logs - SecureCloud{% endblock %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Format timestamp
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // Search functionality
    function searchLogs() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('logsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const event = rows[i].getElementsByTagName('td')[1];
            if (event) {
                const txtValue = event.textContent || event.innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
    }

    // Filter by event type
    function filterByType(type) {
        const table = document.getElementById('logsTable');
        const rows = table.getElementsByTagName('tr');
        
        // Reset all filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-white/10', 'text-white/80');
        });
        
        // Highlight active filter
        if (type !== 'all') {
            document.getElementById('filter-' + type).classList.remove('bg-white/10', 'text-white/80');
            document.getElementById('filter-' + type).classList.add('bg-blue-500', 'text-white');
        } else {
            document.getElementById('filter-all').classList.remove('bg-white/10', 'text-white/80');
            document.getElementById('filter-all').classList.add('bg-blue-500', 'text-white');
        }

        for (let i = 1; i < rows.length; i++) {
            const event = rows[i].getElementsByTagName('td')[1];
            if (event) {
                const txtValue = event.textContent || event.innerText;
                if (type === 'all' || txtValue.toLowerCase().includes(type.toLowerCase())) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
    }

    // Export logs functionality
    function exportLogs() {
        const table = document.getElementById('logsTable');
        const rows = table.getElementsByTagName('tr');
        let csvContent = "Timestamp,Event\n";
        
        for (let i = 1; i < rows.length; i++) {
            if (rows[i].style.display !== 'none') {
                const cols = rows[i].getElementsByTagName('td');
                const timestamp = cols[0].textContent.trim();
                const event = cols[1].textContent.trim();
                csvContent += `"${timestamp}","${event}"\n`;
            }
        }
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'securecloud-logs.csv';
        a.click();
        window.URL.revokeObjectURL(url);
        
        Swal.fire({
            icon: 'success',
            title: 'Xuất thành công!',
            text: 'Nhật ký đã được xuất ra file CSV',
            timer: 2000,
            background: '#1e293b',
            color: '#fff',
            confirmButtonColor: '#10b981'
        });
    }

    // Clear logs (if needed)
    function clearLogs() {
        Swal.fire({
            title: 'Xác nhận xóa?',
            text: 'Bạn có chắc chắn muốn xóa tất cả nhật ký?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy',
            background: '#1e293b',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                // Add your clear logs logic here
                Swal.fire({
                    icon: 'success',
                    title: 'Đã xóa!',
                    text: 'Tất cả nhật ký đã được xóa',
                    timer: 2000,
                    background: '#1e293b',
                    color: '#fff',
                    confirmButtonColor: '#10b981'
                });
            }
        });
    }

    // Get event type icon
    function getEventIcon(event) {
        const eventLower = event.toLowerCase();
        if (eventLower.includes('handshake')) return 'fas fa-handshake text-blue-400';
        if (eventLower.includes('upload')) return 'fas fa-upload text-green-400';
        if (eventLower.includes('download')) return 'fas fa-download text-purple-400';
        if (eventLower.includes('error')) return 'fas fa-exclamation-triangle text-red-400';
        if (eventLower.includes('success')) return 'fas fa-check-circle text-green-400';
        if (eventLower.includes('encrypt')) return 'fas fa-lock text-yellow-400';
        if (eventLower.includes('decrypt')) return 'fas fa-unlock text-orange-400';
        return 'fas fa-info-circle text-gray-400';
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Add icons to existing rows
        const rows = document.querySelectorAll('#logsTable tbody tr');
        rows.forEach(row => {
            const eventCell = row.cells[1];
            if (eventCell) {
                const eventText = eventCell.textContent.trim();
                const icon = getEventIcon(eventText);
                eventCell.innerHTML = `<div class="flex items-center space-x-2"><i class="${icon}"></i><span>${eventText}</span></div>`;
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 fade-in">
    <!-- Header Section -->
    <div class="glass-card p-8">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-history"></i>
            </div>
            <div class="flex-1">
                <h2 class="text-3xl font-bold text-white">Nhật ký Hệ thống</h2>
                <p class="text-white/70">Theo dõi tất cả hoạt động và sự kiện trong hệ thống</p>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="exportLogs()" class="btn-secondary flex items-center">
                    <i class="fas fa-download mr-2"></i>
                    Xuất CSV
                </button>
                <a href="{{ url_for('index') }}" class="btn-primary flex items-center">
                    <i class="fas fa-home mr-2"></i>
                    Trang chủ
                </a>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Search Bar -->
            <div class="lg:col-span-2">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
                    <input type="text" id="searchInput" onkeyup="searchLogs()" 
                           placeholder="Tìm kiếm trong nhật ký..." 
                           class="form-input pl-12">
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div class="flex flex-wrap gap-2">
                <button id="filter-all" onclick="filterByType('all')" 
                        class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white">
                    Tất cả
                </button>
                <button id="filter-handshake" onclick="filterByType('handshake')" 
                        class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-white/10 text-white/80 hover:bg-white/20">
                    Bắt tay
                </button>
                <button id="filter-upload" onclick="filterByType('upload')" 
                        class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-white/10 text-white/80 hover:bg-white/20">
                    Tải lên
                </button>
                <button id="filter-error" onclick="filterByType('error')" 
                        class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-white/10 text-white/80 hover:bg-white/20">
                    Lỗi
                </button>
            </div>
        </div>

        <!-- Status Message -->
        {% if status %}
        <div class="status-info mb-6 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            {{ status }}
        </div>
        {% endif %}
    </div>

    <!-- Logs Table -->
    {% if logs %}
    <div class="glass-card overflow-hidden">
        <!-- Table Header Stats -->
        <div class="bg-white/5 p-6 border-b border-white/10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">{{ logs|length }}</div>
                    <div class="text-white/60 text-sm">Tổng số log</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">
                        {% set success_count = logs|list|length %}
                        {% set success_count = 0 %}
                        {% for log in logs %}
                            {% if 'success' in log[1].lower() or 'successful' in log[1].lower() %}
                                {% set success_count = success_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {{ success_count }}
                    </div>
                    <div class="text-white/60 text-sm">Thành công</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-400">
                        {% set error_count = 0 %}
                        {% for log in logs %}
                            {% if 'error' in log[1].lower() or 'failed' in log[1].lower() %}
                                {% set error_count = error_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {{ error_count }}
                    </div>
                    <div class="text-white/60 text-sm">Lỗi</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400">
                        {% set handshake_count = 0 %}
                        {% for log in logs %}
                            {% if 'handshake' in log[1].lower() %}
                                {% set handshake_count = handshake_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {{ handshake_count }}
                    </div>
                    <div class="text-white/60 text-sm">Bắt tay</div>
                </div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table id="logsTable" class="modern-table">
                <thead>
                    <tr>
                        <th class="flex items-center space-x-2">
                            <i class="fas fa-clock text-blue-400"></i>
                            <span>Thời gian</span>
                        </th>
                        <th>
                            <i class="fas fa-list text-purple-400 mr-2"></i>
                            Sự kiện
                        </th>
                        <th class="text-center">
                            <i class="fas fa-tag text-green-400 mr-2"></i>
                            Trạng thái
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="hover:bg-white/5 transition-colors duration-200">
                        <td class="font-mono text-sm">
                            <div class="text-white/90">{{ log[0] }}</div>
                            <div class="text-white/60 text-xs">
                                <script>document.write(formatTimestamp('{{ log[0] }}'))</script>
                            </div>
                        </td>
                        <td>
                            <div class="flex items-center space-x-3">
                                <div class="w-2 h-2 rounded-full 
                                    {% if 'success' in log[1].lower() or 'successful' in log[1].lower() %}bg-green-400
                                    {% elif 'error' in log[1].lower() or 'failed' in log[1].lower() %}bg-red-400
                                    {% elif 'handshake' in log[1].lower() %}bg-blue-400
                                    {% else %}bg-gray-400{% endif %}">
                                </div>
                                <span class="text-white/90">{{ log[1] }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if 'success' in log[1].lower() or 'successful' in log[1].lower() %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500/20 text-green-300 border border-green-500/30">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Thành công
                                </span>
                            {% elif 'error' in log[1].lower() or 'failed' in log[1].lower() %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-500/20 text-red-300 border border-red-500/30">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Lỗi
                                </span>
                            {% elif 'handshake' in log[1].lower() %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300 border border-blue-500/30">
                                    <i class="fas fa-handshake mr-1"></i>
                                    Bắt tay
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-500/20 text-gray-300 border border-gray-500/30">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Thông tin
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Table Footer -->
        <div class="bg-white/5 p-4 border-t border-white/10">
            <div class="flex justify-between items-center text-white/70 text-sm">
                <span>Hiển thị {{ logs|length }} bản ghi</span>
                <div class="flex items-center space-x-4">
                    <button onclick="location.reload()" class="flex items-center space-x-1 hover:text-white transition-colors">
                        <i class="fas fa-refresh"></i>
                        <span>Làm mới</span>
                    </button>
                    <button onclick="exportLogs()" class="flex items-center space-x-1 hover:text-white transition-colors">
                        <i class="fas fa-download"></i>
                        <span>Xuất file</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="glass-card p-12 text-center">
        <div class="w-24 h-24 bg-gradient-to-r from-gray-400 to-gray-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-history text-white text-3xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-4">Chưa có nhật ký</h3>
        <p class="text-white/70 mb-8">Hệ thống chưa ghi nhận hoạt động nào. Các sự kiện sẽ được hiển thị tại đây khi có hoạt động.</p>
        <a href="{{ url_for('index') }}" class="btn-primary inline-flex items-center">
            <i class="fas fa-upload mr-2"></i>
            Bắt đầu tải file
        </a>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="glass-card p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <i class="fas fa-bolt text-yellow-400 mr-2"></i>
            Thao tác nhanh
        </h3>
        <div class="flex flex-wrap gap-4">
            <a href="{{ url_for('index') }}" class="btn-secondary flex items-center">
                <i class="fas fa-home mr-2"></i>
                Trang chủ
            </a>
            <a href="{{ url_for('list_files') }}" class="btn-secondary flex items-center">
                <i class="fas fa-folder mr-2"></i>
                Quản lý file
            </a>
            <button onclick="location.reload()" class="btn-secondary flex items-center">
                <i class="fas fa-refresh mr-2"></i>
                Làm mới nhật ký
            </button>
            <button onclick="exportLogs()" class="btn-secondary flex items-center">
                <i class="fas fa-file-export mr-2"></i>
                Xuất báo cáo
            </button>
        </div>
    </div>

    <!-- System Info -->
    <div class="glass-card p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
            Thông tin hệ thống
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
            <div class="bg-white/5 rounded-lg p-4">
                <div class="text-white/60 mb-1">Trạng thái hệ thống</div>
                <div class="text-green-400 font-semibold flex items-center">
                    <i class="fas fa-circle mr-2 text-xs"></i>
                    Hoạt động bình thường
                </div>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
                <div class="text-white/60 mb-1">Cập nhật cuối</div>
                <div class="text-white/90 font-semibold">
                    <script>document.write(new Date().toLocaleString('vi-VN'))</script>
                </div>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
                <div class="text-white/60 mb-1">Bảo mật</div>
                <div class="text-blue-400 font-semibold flex items-center">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Được bảo vệ
                </div>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
                <div class="text-white/60 mb-1">Phiên bản</div>
                <div class="text-white/90 font-semibold">SecureCloud v2.0</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}